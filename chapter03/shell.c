#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/wait.h>
/*
 * stdio.h:
 *   fprintf(), fgets(), sscanf() などの標準入出力関数を使用する。
 *
 * unistd.h:
 *   fork(), execl() などのプロセス制御系システムコールを使用する。
 *
 * stdlib.h:
 *   exit() を使用するために必要。
 *
 * sys/wait.h:
 *   wait() を使用するために必要。
 *   子プロセスの終了を待つためのAPI。
 */

int main(void){
    pid_t pid;
    /*
     * pid:
     *   fork() の戻り値を受け取る変数。
     *
     *   fork() の戻り値の意味：
     *     - 親プロセスでは「子プロセスのPID（正の値）」
     *     - 子プロセスでは「0」
     *     - エラー時は「-1」
     */

    int st, ret;
    /*
     * st:
     *   wait() により取得する子プロセスの終了ステータス。
     *
     * ret:
     *   execl() の戻り値を受け取る。
     *   成功時は戻らない。
     *   失敗時のみ -1 が返る。
     */

    char line[256], command[256];
    /*
     * line:
     *   ユーザーが入力した1行分を格納するバッファ。
     *
     * command:
     *   実行するコマンド名のみを抽出するためのバッファ。
     *
     * どちらも固定長配列であり、
     * バッファサイズを超える入力には注意が必要。
     */

    while(1){
        /*
         * 無限ループ。
         * シェルのように、ユーザーから繰り返しコマンド入力を受け付ける。
         */

        fprintf(stderr, "--> ");
        /*
         * プロンプト表示。
         * ユーザーに入力を促す。
         */

        fgets(line, sizeof(line), stdin);
        /*
         * 標準入力から1行読み込む。
         * 改行も含めて line に格納される。
         *
         * EOF（Ctrl+D）時のチェックはしていない点に注意。
         */

        sscanf(line, "%s", command);
        /*
         * 入力行の先頭の単語だけを取り出す。
         *
         * 例:
         *   入力: "ls -l"
         *   command = "ls"
         *
         * 引数部分（-lなど）は無視される。
         *
         * このため、実装としては非常に単純な
         * 「単一コマンドのみ実行可能な簡易シェル」である。
         */

        pid = fork();
        /*
         * 現在のプロセスを複製する。
         *
         * fork() 後は
         *   - 親プロセス
         *   - 子プロセス
         * の2つが存在する。
         *
         * 両方が fork() の次の行から実行を続ける。
         */

        if(pid == 0){
            /*
             * 子プロセス側の処理。
             *
             * ここで exec 系を呼び出すことで、
             * 子プロセスを指定コマンドに置き換える。
             */

            ret = execl(command, command, NULL);
            /*
             * execl():
             *   現在のプロセスを別プログラムに置き換える。
             *
             * 引数:
             *   第1引数: 実行ファイルのパス
             *   第2引数: argv[0]
             *   NULL: 引数終端
             *
             * ここでは引数なしコマンドのみ実行可能。
             *
             * 成功すれば戻らない。
             * 失敗した場合のみ -1 を返す。
             */

            if(ret < 0){
                /*
                 * execl() が失敗した場合。
                 *
                 * 例:
                 *   - コマンドが存在しない
                 *   - 実行権限がない
                 */

                exit(0);
                /*
                 * 子プロセスを終了させる。
                 *
                 * exit を呼ばないと、
                 * 子がこのまま while ループに戻ってしまう可能性がある。
                 */
            }
        }
        else{
            /*
             * 親プロセス側の処理。
             */

            wait(&st);
            /*
             * 子プロセスが終了するまで待つ。
             *
             * これにより、
             * 親は子が終了するまで次の入力を受け付けない。
             *
             * wait() がなければ、
             * ゾンビプロセスが発生する可能性がある。
             */
        }
    }

    return 0;
    /*
     * 実質的に到達しない。
     * while(1) により永久にループする。
     */
}
